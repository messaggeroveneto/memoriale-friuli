<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Memoriale – Friuli 1976</title>
<style>
  :root{
    --bg:#000;
    --text:#f3f4f7;
    --muted:rgba(243,244,247,.70);
    --line:rgba(255,255,255,.10);
    --tile:rgba(255,255,255,.04);
    --tileLine:rgba(255,255,255,.10);
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;

    /* polvere bianca leggera */
    background-image:
      radial-gradient(circle at 12% 18%, rgba(255,255,255,.06) 1px, transparent 2px),
      radial-gradient(circle at 72% 30%, rgba(255,255,255,.05) 1px, transparent 2px),
      radial-gradient(circle at 44% 76%, rgba(255,255,255,.04) 1px, transparent 2px),
      radial-gradient(circle at 86% 82%, rgba(255,255,255,.05) 1px, transparent 2px),
      radial-gradient(circle at 20% 60%, rgba(255,255,255,.03) 1px, transparent 2px),
      radial-gradient(900px 500px at 50% 0%, rgba(255,255,255,.08), transparent 60%);
    background-size: 180px 180px,220px 220px,260px 260px,240px 240px,300px 300px,auto;
  }

  /* HERO */
  .hero{
    padding:14px 14px 10px;
    border-bottom:1px solid var(--line);
    background: rgba(0,0,0,.80);
    backdrop-filter: blur(10px);
  }
  .masthead{ display:flex; align-items:center; gap:10px; }
  .logo{ height:26px; width:auto; display:block; filter: brightness(1.08) contrast(1.05); }
  .brand{ font-size:14px; letter-spacing:.2px; color:rgba(243,244,247,.88); font-weight:650; }
  h1{ margin:10px 0 0; font-size: clamp(18px, 2.2vw, 28px); font-weight:750; letter-spacing:.2px; }

  /* SEARCH BAR */
  header{
    position:sticky; top:0; z-index:20;
    padding:10px 14px 12px;
    background: rgba(0,0,0,.90);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  select,input,button{
    border-radius:12px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    color: var(--text);
    padding:10px 12px;
    outline:none;
  }
  select{
    padding-right:32px;
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(243,244,247,.9) 50%),
      linear-gradient(135deg, rgba(243,244,247,.9) 50%, transparent 50%),
      linear-gradient(to right, transparent, transparent);
    background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%, 0 0;
    background-size: 6px 6px, 6px 6px, 100% 100%;
    background-repeat:no-repeat;
  }
  select option{ background:#000; color:#fff; } /* non sempre rispettato dal browser */
  input{ flex:1; min-width:220px; }
  button{ cursor:pointer; }
  button:hover{ background:rgba(255,255,255,.09); }

  /* STAGE + TRANSITION */
  .wrap{ position:relative; height: calc(100vh - 0px); width:100%; }
  .stage{
    position:relative;
    padding:16px;
  }
  .topline{
    display:flex; justify-content:space-between; align-items:baseline;
    gap:12px; padding:6px 6px 10px;
    color:rgba(243,244,247,.68); font-size:12px;
  }
  .field{
    position:relative;
    height: calc(100vh - 220px); /* abbastanza stabile con hero+header */
    border:1px solid var(--line);
    border-radius:22px;
    background: rgba(255,255,255,.02);
    overflow:hidden;
    display:flex;
    align-items:stretch;
    justify-content:center;
  }

  /* due “pagine” sovrapposte per animazione */
  .pages{
    position:relative;
    width:100%;
    height:100%;
  }
  .page{
    position:absolute;
    inset:0;
    padding:18px;
    display:grid;
    gap:12px;
    opacity:1;
    transform: translateX(0);
    transition: opacity 520ms ease, transform 520ms ease;
  }
  .page.out-left{ opacity:0; transform: translateX(-26px); }
  .page.out-right{ opacity:0; transform: translateX(26px); }
  .page.in-left{ opacity:0; transform: translateX(-26px); }
  .page.in-right{ opacity:0; transform: translateX(26px); }

  /* griglia responsive: desktop 4 colonne, tablet 2, mobile 1 */
  .grid-4{ grid-template-columns: repeat(4, minmax(0, 1fr)); grid-auto-rows: 1fr; }
  .grid-2{ grid-template-columns: repeat(2, minmax(0, 1fr)); grid-auto-rows: 1fr; }
  .grid-1{ grid-template-columns: 1fr; grid-auto-rows: 1fr; }

  .tile{
    border:1px solid var(--tileLine);
    background: var(--tile);
    border-radius:18px;
    padding:12px 12px 10px;
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 40px rgba(0,0,0,.40);
    overflow:hidden;
  }
  .name{
    font-weight:650;
    line-height:1.15;
    letter-spacing:.2px;
    font-size: clamp(14px, 2.2vw, 18px);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .place{
    margin-top:6px;
    color:rgba(243,244,247,.72);
    font-size: clamp(11px, 1.7vw, 13px);
    font-style: italic;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .hint{
    position:fixed; left:14px; right:14px; bottom:10px;
    text-align:center; color:rgba(243,244,247,.55);
    font-size:12px; pointer-events:none;
  }

  @media (prefers-reduced-motion: reduce){
    .page{ transition:none; }
  }
</style>
</head>
<body>

<div class="hero">
  <div class="masthead">
    <img class="logo" alt="messaggeroveneto"
      src="https://socialcomitalia.com/wp-content/uploads/2022/07/Loghi-giornali-1920-%C3%97-480-px-12.png">
    <div class="brand">messaggeroveneto</div>
  </div>
  <h1>Mille vittime, tutti i nomi.</h1>
</div>

<header>
  <select id="fieldSel" aria-label="Campo di ricerca">
    <option value="nome">Nome</option>
    <option value="cognome">Cognome</option>
    <option value="luogo">Luogo</option>
  </select>

  <input id="q" type="search" placeholder="Cerca…" autocomplete="off" />
  <button id="reset" title="Azzera ricerca">Reset</button>
</header>

<div class="wrap">
  <div class="stage">
    <div class="topline">
      <div id="subtitle">Scorri per cambiare pagina</div>
      <div id="counter">—</div>
    </div>

    <div class="field">
      <div class="pages" id="pages"></div>
    </div>
  </div>
</div>

<div class="hint">Scroll • Frecce ↑ ↓ • Touch swipe</div>

<script>
  const pagesEl = document.getElementById("pages");
  const counter = document.getElementById("counter");
  const subtitle = document.getElementById("subtitle");

  const qEl = document.getElementById("q");
  const fieldSel = document.getElementById("fieldSel");
  const resetBtn = document.getElementById("reset");

  let ALL = [];
  let VIEW = [];
  let page = 0;

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function norm(s){
    return (s||"").toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"")
      .replace(/\s+/g," ").trim();
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // responsive: definisce columns + page size
  function getLayout(){
    const w = window.innerWidth;
    if (w <= 520) return { cols: 1, size: 5, cls: "grid-1" };   // mobile
    if (w <= 900) return { cols: 2, size: 8, cls: "grid-2" };   // tablet (2x4)
    return { cols: 4, size: 12, cls: "grid-4" };                // desktop (4x3)
  }
  let LAYOUT = getLayout();

  function applyFilter(){
    const q = norm(qEl.value);
    const f = fieldSel.value;

    if(!q){
      VIEW = ALL.slice();
      subtitle.textContent = "Scorri per cambiare pagina";
    } else {
      VIEW = ALL.filter(r => norm(r[f]).includes(q));
      subtitle.textContent = `Filtro: ${f} contiene “${qEl.value}”`;
    }

    page = 0;
    renderPage("right"); // entra da destra
  }

  function makeTiles(slice){
    return slice.map(r => `
      <div class="tile">
        <div class="name">${escapeHtml(r.nome)} ${escapeHtml(r.cognome)}</div>
        <div class="place">${r.luogo ? escapeHtml(r.luogo) : ""}</div>
      </div>
    `).join("");
  }

  function renderPage(direction){
    // direction: "right" (avanti) o "left" (indietro)
    const { size, cls } = LAYOUT;
    const totalPages = Math.max(1, Math.ceil(VIEW.length / size));
    page = clamp(page, 0, totalPages - 1);

    const start = page * size;
    const slice = VIEW.slice(start, start + size);

    counter.textContent =
      `Pagina ${page+1}/${totalPages} • Nomi ${VIEW.length ? (start+1) : 0}-${Math.min(start+size, VIEW.length)} / ${VIEW.length}`;

    const newPage = document.createElement("div");
    newPage.className = `page ${cls} ` + (direction === "right" ? "in-right" : "in-left");
    newPage.innerHTML = makeTiles(slice);

    const oldPage = pagesEl.querySelector(".page");

    pagesEl.appendChild(newPage);

    // forza reflow per far partire l’animazione
    newPage.getBoundingClientRect();

    // entra
    newPage.classList.remove("in-right","in-left");

    // esce il vecchio
    if(oldPage){
      oldPage.classList.add(direction === "right" ? "out-left" : "out-right");
      // rimuovi dopo transizione
      setTimeout(() => oldPage.remove(), 560);
    }
  }

  function step(delta){
    const { size } = LAYOUT;
    const totalPages = Math.max(1, Math.ceil(VIEW.length / size));
    const next = clamp(page + delta, 0, totalPages - 1);
    if(next === page) return;
    page = next;
    renderPage(delta > 0 ? "right" : "left");
  }

  // scroll pagina (debounce)
  let wheelLock = false;
  window.addEventListener("wheel", (e) => {
    e.preventDefault();
    if (wheelLock) return;
    wheelLock = true;
    step(e.deltaY > 0 ? 1 : -1);
    setTimeout(() => wheelLock = false, 320);
  }, { passive:false });

  // tastiera
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ") { e.preventDefault(); step(1); }
    if (e.key === "ArrowUp" || e.key === "PageUp") { e.preventDefault(); step(-1); }
    if (e.key === "Home") { e.preventDefault(); page=0; renderPage("right"); }
    if (e.key === "End")  { e.preventDefault(); page=999999; renderPage("right"); }
  });

  // swipe
  let startY = null;
  window.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    startY = e.touches[0].clientY;
  }, { passive:true });

  window.addEventListener("touchend", (e) => {
    if (startY == null) return;
    const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
    const dy = endY - startY;
    if (Math.abs(dy) > 30) step(dy < 0 ? 1 : -1);
    startY = null;
  }, { passive:true });

  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const sep = lines[0].includes(";") ? ";" : ",";
    const headers = lines.shift().split(sep).map(h => h.trim());
    const iC = headers.findIndex(h => h.toLowerCase() === "cognome");
    const iN = headers.findIndex(h => h.toLowerCase() === "nome");
    const iL = headers.findIndex(h => h.toLowerCase() === "luogo");

    const out = [];
    for(const line of lines){
      if(!line.trim()) continue;
      const cells = line.split(sep).map(s => s.trim());
      const nome = cells[iN] || "";
      const cognome = cells[iC] || "";
      const luogo = cells[iL] || "";
      const full = (nome + " " + cognome).trim();
      if(full) out.push({ nome, cognome, luogo });
    }
    out.sort((a,b) => (a.cognome+" "+a.nome).localeCompare(b.cognome+" "+b.nome, "it"));
    return out;
  }

  async function load(){
    const res = await fetch("Morti_Terremoto.csv", { cache:"no-store" });
    const buf = await res.arrayBuffer();
    let text;
    try { text = new TextDecoder("iso-8859-1").decode(buf); }
    catch { text = new TextDecoder("utf-8").decode(buf); }

    ALL = parseCSV(text);
    VIEW = ALL.slice();

    qEl.addEventListener("input", applyFilter);
    fieldSel.addEventListener("change", applyFilter);
    resetBtn.addEventListener("click", () => {
      qEl.value = "";
      applyFilter();
      qEl.focus();
    });

    renderPage("right");

    // resize: aggiorna layout e mantiene il “punto” nell’elenco
    window.addEventListener("resize", () => {
      const old = LAYOUT;
      const nw = getLayout();
      if (nw.size !== old.size){
        const anchor = page * old.size;
        LAYOUT = nw;
        page = Math.floor(anchor / LAYOUT.size);
      } else {
        LAYOUT = nw;
      }
      renderPage("right");
    });
  }

  load().catch(err => {
    console.error(err);
    pagesEl.innerHTML = `<div class="page grid-1">
      <div class="tile"><div class="name">Errore nel caricamento</div><div class="place">Controlla Morti_Terremoto.csv</div></div>
    </div>`;
    counter.textContent = "";
  });
</script>

</body>
</html>
