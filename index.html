<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Memoriale – Friuli 1976</title>
<style>
  :root{
    --paper:#f3f1ea;      /* avorio */
    --ink:#111111;        /* testo */
    --muted:#444;         /* secondario */
    --line:rgba(0,0,0,.10);
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--paper);
    color:var(--ink);
    font-family: Georgia, "Times New Roman", Times, serif;
    overflow:hidden;

    /* “omini” sparsi sullo sfondo, molto delicati */
    background-image:
      radial-gradient(900px 420px at 50% 0%, rgba(0,0,0,.06), transparent 65%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='240' viewBox='0 0 520 240'%3E%3Cg fill='%23000000' fill-opacity='.12'%3E%3Cpath d='M78 86c9 0 16-7 16-16s-7-16-16-16-16 7-16 16 7 16 16 16zm0 10c-18 0-32 12-32 28v22h14v62c0 6 4 10 10 10s10-4 10-10v-62h14v62c0 6 4 10 10 10s10-4 10-10v-62h14v-22c0-16-14-28-32-28z'/%3E%3Cpath d='M246 110c8 0 14-6 14-14s-6-14-14-14-14 6-14 14 6 14 14 14zm0 10c-16 0-28 11-28 25v20h12v56c0 5 4 9 9 9s9-4 9-9v-56h12v56c0 5 4 9 9 9s9-4 9-9v-56h12v-20c0-14-12-25-28-25z'/%3E%3Cpath d='M420 92c8 0 14-6 14-14s-6-14-14-14-14 6-14 14 6 14 14 14zm0 10c-16 0-28 11-28 25v20h12v66c0 5 4 9 9 9s9-4 9-9v-66h12v66c0 5 4 9 9 9s9-4 9-9v-66h12v-20c0-14-12-25-28-25z'/%3E%3C/g%3E%3Cg fill='%23000000' fill-opacity='.10'%3E%3Cellipse cx='86' cy='220' rx='30' ry='7'/%3E%3Cellipse cx='254' cy='232' rx='26' ry='6'/%3E%3Cellipse cx='428' cy='224' rx='28' ry='7'/%3E%3C/g%3E%3C/svg%3E");
    background-repeat: no-repeat, repeat;
    background-size: auto, 760px 360px;
  }

  /* testata (puoi togliere logo se vuoi) */
  .hero{
    padding:16px 14px 12px;
    border-bottom:1px solid var(--line);
    background: rgba(243,241,234,.88);
    backdrop-filter: blur(6px);
  }
  .masthead{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo{
    height:22px;
    width:auto;
    display:block;
    filter: grayscale(100%) contrast(1.15);
    opacity:.9;
  }
  .brand{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:13px;
    letter-spacing:.2px;
    color:rgba(0,0,0,.75);
    font-weight:650;
    text-transform: lowercase;
  }
  h1{
    margin:10px 0 0;
    font-size: clamp(20px, 2.2vw, 30px);
    font-weight:700;
    letter-spacing:.2px;
  }

  /* ricerca */
  header{
    position:sticky;
    top:0;
    z-index:20;
    padding:10px 14px 12px;
    background: rgba(243,241,234,.92);
    border-bottom:1px solid var(--line);
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  select,input,button{
    border-radius:12px;
    border:1px solid rgba(0,0,0,.16);
    background: rgba(255,255,255,.55);
    color: var(--ink);
    padding:10px 12px;
    outline:none;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:14px;
  }
  select{ padding-right:24px; }
  input{ flex:1; min-width:220px; }
  button{ cursor:pointer; }
  button:hover{ background: rgba(255,255,255,.75); }

  .wrap{
    position:relative;
    height: calc(100vh - 0px);
    width:100%;
  }

  /* transizione pagina */
  .fade-out .stage{
    opacity:0;
    transform: translateY(10px);
  }
  .stage{
    position:absolute;
    inset:0;
    padding:14px;
    opacity:1;
    transform: translateY(0);
    transition: opacity 520ms ease, transform 520ms ease;
  }

  .topline{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:12px;
    padding:6px 6px 10px;
    color: rgba(0,0,0,.55);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:12px;
  }

  .panel{
    border:1px solid var(--line);
    border-radius:18px;
    background: rgba(255,255,255,.45);
    backdrop-filter: blur(6px);
    padding: 10px 10px;
    height: calc(100vh - 240px);
    overflow:hidden;
  }

  /* lista “NYT-like” */
  .list{
    margin:0;
    padding:0;
    list-style:none;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .item{
    display:flex;
    gap:12px;
    align-items:flex-start;
    padding:10px 10px;
    border-bottom: 1px solid rgba(0,0,0,.08);
  }
  .item:last-child{ border-bottom:none; }

  .sil{
    width:22px;
    height:22px;
    flex:0 0 22px;
    opacity:.9;
    margin-top:2px;
  }

  .name{
    font-size: clamp(18px, 2.0vw, 24px);
    font-weight:700;
    line-height:1.15;
    margin:0;
  }
  .meta{
    margin-top:4px;
    font-size: clamp(13px, 1.4vw, 15px);
    color: rgba(0,0,0,.70);
    font-style: italic;
    line-height:1.25;
  }

  .hint{
    position:fixed;
    left:14px;
    right:14px;
    bottom:10px;
    text-align:center;
    color: rgba(0,0,0,.50);
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:12px;
    pointer-events:none;
  }

  @media (prefers-reduced-motion: reduce){
    .stage{ transition:none; }
  }
</style>
</head>
<body>

<div class="hero">
  <div class="masthead">
    <img class="logo" alt="messaggeroveneto"
      src="https://socialcomitalia.com/wp-content/uploads/2022/07/Loghi-giornali-1920-%C3%97-480-px-12.png">
    <div class="brand">messaggeroveneto</div>
  </div>
  <h1>Mille vittime, tutti i nomi.</h1>
</div>

<header>
  <select id="fieldSel" aria-label="Campo di ricerca">
    <option value="nome">Nome</option>
    <option value="cognome">Cognome</option>
    <option value="luogo">Luogo</option>
  </select>
  <input id="q" type="search" placeholder="Cerca…" autocomplete="off" />
  <button id="reset">Reset</button>
</header>

<div class="wrap" id="wrap">
  <div class="stage" id="stage">
    <div class="topline">
      <div id="subtitle">Scorri per cambiare pagina</div>
      <div id="counter">—</div>
    </div>

    <div class="panel">
      <ul class="list" id="list"></ul>
    </div>
  </div>
</div>

<div class="hint">Scroll • Frecce ↑ ↓ • Touch swipe</div>

<script>
  const wrap = document.getElementById("wrap");
  const listEl = document.getElementById("list");
  const counter = document.getElementById("counter");
  const subtitle = document.getElementById("subtitle");

  const qEl = document.getElementById("q");
  const fieldSel = document.getElementById("fieldSel");
  const resetBtn = document.getElementById("reset");

  let ALL = [];
  let VIEW = [];
  let page = 0;

  function getPageSize(){
    const w = window.innerWidth;
    if (w <= 520) return 5;
    if (w <= 900) return 8;
    return 12;
  }
  let PAGE_SIZE = getPageSize();

  const silhouetteSVG = `
    <svg class="sil" viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M12 12.2a4.2 4.2 0 1 0-0.01 0Zm0 2.1c-4.3 0-7.8 2.8-7.8 6.3V22h15.6v-1.4c0-3.5-3.5-6.3-7.8-6.3Z"/>
    </svg>`;

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function norm(s){
    return (s||"").toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"")
      .replace(/\s+/g," ").trim();
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  function applyFilter(){
    const q = norm(qEl.value);
    const f = fieldSel.value;

    if(!q){
      VIEW = ALL.slice();
      subtitle.textContent = "Scorri per cambiare pagina";
    } else {
      VIEW = ALL.filter(r => norm(r[f]).includes(q));
      subtitle.textContent = `Filtro: ${f} contiene “${qEl.value}”`;
    }

    page = 0;
    render();
  }

  function render(){
    const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    page = clamp(page, 0, totalPages - 1);

    const start = page * PAGE_SIZE;
    const slice = VIEW.slice(start, start + PAGE_SIZE);

    counter.textContent = `Pagina ${page+1}/${totalPages} • Nomi ${VIEW.length ? (start+1) : 0}-${Math.min(start+PAGE_SIZE, VIEW.length)} / ${VIEW.length}`;

    listEl.innerHTML = slice.map(r => `
      <li class="item">
        <div style="color: rgba(0,0,0,.70)">${silhouetteSVG}</div>
        <div>
          <p class="name">${escapeHtml(r.nome)} ${escapeHtml(r.cognome)}</p>
          <div class="meta">${r.luogo ? escapeHtml(r.luogo) : ""}</div>
        </div>
      </li>
    `).join("");
  }

  function step(delta){
    const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    const next = clamp(page + delta, 0, totalPages - 1);
    if(next === page) return;

    wrap.classList.add("fade-out");
    setTimeout(() => {
      page = next;
      render();
      requestAnimationFrame(() => wrap.classList.remove("fade-out"));
    }, 220);
  }

  // Wheel
  let wheelLock = false;
  window.addEventListener("wheel", (e) => {
    e.preventDefault();
    if (wheelLock) return;
    wheelLock = true;
    step(e.deltaY > 0 ? 1 : -1);
    setTimeout(() => wheelLock = false, 280);
  }, { passive:false });

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ") { e.preventDefault(); step(1); }
    if (e.key === "ArrowUp" || e.key === "PageUp") { e.preventDefault(); step(-1); }
    if (e.key === "Home") { e.preventDefault(); page=0; render(); }
    if (e.key === "End") { e.preventDefault(); page=999999; render(); }
  });

  // Touch swipe
  let startY = null;
  window.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    startY = e.touches[0].clientY;
  }, { passive:true });

  window.addEventListener("touchend", (e) => {
    if (startY == null) return;
    const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
    const dy = endY - startY;
    if (Math.abs(dy) > 30) step(dy < 0 ? 1 : -1);
    startY = null;
  }, { passive:true });

  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const sep = lines[0].includes(";") ? ";" : ",";
    const headers = lines.shift().split(sep).map(h => h.trim());
    const iC = headers.findIndex(h => h.toLowerCase() === "cognome");
    const iN = headers.findIndex(h => h.toLowerCase() === "nome");
    const iL = headers.findIndex(h => h.toLowerCase() === "luogo");

    const out = [];
    for(const line of lines){
      if(!line.trim()) continue;
      const cells = line.split(sep).map(s => s.trim());
      const nome = cells[iN] || "";
      const cognome = cells[iC] || "";
      const luogo = cells[iL] || "";
      const full = (nome + " " + cognome).trim();
      if(full) out.push({ nome, cognome, luogo });
    }
    out.sort((a,b) => (a.cognome+" "+a.nome).localeCompare(b.cognome+" "+b.nome, "it"));
    return out;
  }

  async function load(){
    const res = await fetch("Morti_Terremoto.csv", { cache:"no-store" });
    const buf = await res.arrayBuffer();
    let text;
    try { text = new TextDecoder("iso-8859-1").decode(buf); }
    catch { text = new TextDecoder("utf-8").decode(buf); }

    ALL = parseCSV(text);
    VIEW = ALL.slice();

    qEl.addEventListener("input", applyFilter);
    fieldSel.addEventListener("change", applyFilter);
    resetBtn.addEventListener("click", () => { qEl.value=""; applyFilter(); qEl.focus(); });

    render();

    window.addEventListener("resize", () => {
      const old = PAGE_SIZE;
      const nw = getPageSize();
      if(nw !== old){
        const anchor = page * old;
        PAGE_SIZE = nw;
        page = Math.floor(anchor / PAGE_SIZE);
      }
      render();
    });
  }

  load().catch(err => {
    console.error(err);
    listEl.innerHTML = `<li class="item"><div>${silhouetteSVG}</div><div><p class="name">Errore nel caricamento</p><div class="meta">Controlla Morti_Terremoto.csv</div></div></li>`;
    counter.textContent = "";
  });
</script>

</body>
</html>
