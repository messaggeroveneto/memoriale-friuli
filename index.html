<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Memoriale ‚Äì Terremoto del Friuli (1976)</title>
<style>
  :root{
    --bg:#0b0c10;
    --text:#f3f4f7;
    --muted:rgba(243,244,247,.70);
    --line:rgba(255,255,255,.10);
    --chip:rgba(255,255,255,.05);
    --chipLine:rgba(255,255,255,.12);
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;

    /* ‚Äúmacerie‚Äù: pattern astratto (non foto) in trasparenza */
    background-image:
      radial-gradient(900px 500px at 50% 0%, rgba(255,255,255,.08), transparent 60%),
      radial-gradient(900px 500px at 20% 85%, rgba(255,255,255,.06), transparent 55%),
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'%3E%3Cg fill='%23ffffff' fill-opacity='.06'%3E%3Cpath d='M18 162l34-18 22 10-18 20z'/%3E%3Cpath d='M74 182l30-28 26 12-14 26z'/%3E%3Cpath d='M136 194l26-22 34 14-18 22z'/%3E%3Cpath d='M26 118l26-16 18 10-12 18z'/%3E%3Cpath d='M80 130l30-20 22 12-18 24z'/%3E%3Cpath d='M136 136l28-18 24 10-16 20z'/%3E%3Cpath d='M20 72l22-14 16 8-10 16z'/%3E%3Cpath d='M66 80l26-16 18 10-12 18z'/%3E%3Cpath d='M116 86l28-18 20 10-16 20z'/%3E%3Cpath d='M166 92l24-14 16 8-10 16z'/%3E%3C/g%3E%3Cg fill='none' stroke='%23ffffff' stroke-opacity='.05' stroke-width='2'%3E%3Cpath d='M10 205c55-28 75-28 120-10 40 16 60 10 80-2'/%3E%3Cpath d='M0 150c55-28 75-28 120-10 40 16 60 10 80-2'/%3E%3C/g%3E%3C/svg%3E");
    background-size: auto, auto, 260px 260px;
    background-repeat: no-repeat, no-repeat, repeat;
  }

  /* Barra ricerca */
  header{
    position:sticky;
    top:0;
    z-index:20;
    padding:12px 14px;
    background:rgba(11,12,16,.86);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .brand{
    font-size:12px;
    color:rgba(243,244,247,.72);
    letter-spacing:.2px;
    white-space:nowrap;
  }
  select,input,button{
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.04);
    color:var(--text);
    padding:10px 12px;
    outline:none;
  }
  select{ padding-right:28px; }
  input{ flex:1; min-width:220px; }
  button{ cursor:pointer; }
  button:hover{ background:rgba(255,255,255,.06); }

  .wrap{
    position:relative;
    height: calc(100vh - 58px);
    width:100%;
  }
  .fade-out .stage{
    opacity:0;
    transform: translateY(10px);
  }
  .stage{
    position:absolute;
    inset:0;
    padding:16px;
    opacity:1;
    transform: translateY(0);
    transition: opacity 420ms ease, transform 420ms ease;
  }

  .topline{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:12px;
    padding:6px 6px 10px;
    color:rgba(243,244,247,.68);
    font-size:12px;
  }

  .field{
    position:relative;
    height: calc(100% - 34px);
    border:1px solid var(--line);
    border-radius:22px;
    background: rgba(0,0,0,.20);
    overflow:hidden;
  }

  .tag{
    position:absolute;
    max-width: min(520px, 74vw);
    padding:10px 12px;
    border-radius:18px;
    border:1px solid var(--chipLine);
    background: var(--chip);
    backdrop-filter: blur(8px);
    box-shadow: 0 10px 40px rgba(0,0,0,.45);
    user-select:none;
  }
  .tag .name{
    color:var(--text);
    font-weight:650;
    line-height:1.15;
    font-size: clamp(14px, 1.6vw, 18px);
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tag .place{
    margin-top:6px;
    color:rgba(243,244,247,.70);
    font-size: clamp(11px, 1.2vw, 13px);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .hint{
    position:fixed;
    left:14px;
    right:14px;
    bottom:10px;
    text-align:center;
    color:rgba(243,244,247,.55);
    font-size:12px;
    pointer-events:none;
  }

  @media (prefers-reduced-motion: reduce){
    .stage{ transition:none; }
  }
</style>
</head>
<body>

<header>
  <div class="brand">Memoriale ‚Ä¢ Friuli 1976</div>

  <select id="fieldSel" aria-label="Campo di ricerca">
    <option value="nome">Nome</option>
    <option value="cognome" selected>Cognome</option>
    <option value="luogo">Luogo</option>
  </select>

  <input id="q" type="search" placeholder="Cerca‚Ä¶" autocomplete="off" />

  <button id="reset" title="Azzera ricerca">Reset</button>
</header>

<div class="wrap" id="wrap">
  <div class="stage" id="stage">
    <div class="topline">
      <div id="subtitle">Scorri per cambiare pagina</div>
      <div id="counter">‚Äî</div>
    </div>
    <div class="field" id="field" aria-live="polite"></div>
  </div>
</div>

<div class="hint">Scroll ‚Ä¢ Frecce ‚Üë ‚Üì ‚Ä¢ Touch swipe</div>

<script>
  const wrap = document.getElementById("wrap");
  const field = document.getElementById("field");
  const counter = document.getElementById("counter");
  const subtitle = document.getElementById("subtitle");

  const qEl = document.getElementById("q");
  const fieldSel = document.getElementById("fieldSel");
  const resetBtn = document.getElementById("reset");

  let ALL = [];
  let VIEW = [];
  let page = 0;

  // meno nomi per pagina, pi√π sparsi
  const PAGE_SIZE = 12;

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
  function norm(s){
    return (s||"").toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"")
      .replace(/\s+/g," ").trim();
  }

  // RNG deterministico (layout stabile per pagina+query)
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }

  function applyFilter(){
    const q = norm(qEl.value);
    const f = fieldSel.value;

    if(!q){
      VIEW = ALL.slice();
      subtitle.textContent = "Scorri per cambiare pagina";
    } else {
      VIEW = ALL.filter(r => norm(r[f]).includes(q));
      subtitle.textContent = `Filtro: ${f} contiene ‚Äú${qEl.value}‚Äù`;
    }

    page = 0;
    render();
  }

  function groupByCognome(list){
    const map = new Map();
    for(const r of list){
      const k = r.cognome || "";
      if(!map.has(k)) map.set(k, []);
      map.get(k).push(r);
    }
    // ordina gruppi per cognome (stabile)
    return [...map.entries()].sort((a,b)=> (a[0]||"").localeCompare(b[0]||"", "it"))
      .map(([k, arr]) => ({ cognome:k, items: arr }));
  }

  function render(){
    const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    page = clamp(page, 0, totalPages - 1);

    const start = page * PAGE_SIZE;
    const slice = VIEW.slice(start, start + PAGE_SIZE);

    counter.textContent = `Pagina ${page+1}/${totalPages} ‚Ä¢ Nomi ${VIEW.length ? (start+1) : 0}-${Math.min(start+PAGE_SIZE, VIEW.length)} / ${VIEW.length}`;

    field.innerHTML = "";

    const W = field.clientWidth;
    const H = field.clientHeight;
    const pad = 22;

    // seed cambia con pagina+query+campo (layout ‚Äúcoerente‚Äù)
    const seed = 12345 + page*99991 + norm(qEl.value).length*101 + (fieldSel.value.charCodeAt(0) || 0);
    const rand = mulberry32(seed);

    // Raggruppa per cognome: ‚Äúisole‚Äù vicine
    const groups = groupByCognome(slice);

    // crea nodi prima per misurarli
    const groupNodes = groups.map(g => {
      const nodes = g.items.map(r => {
        const div = document.createElement("div");
        div.className = "tag";
        div.innerHTML = `
          <div class="name">${escapeHtml(r.nome)} ${escapeHtml(r.cognome)}</div>
          <div class="place">${r.luogo ? "üìç " + escapeHtml(r.luogo) : ""}</div>
        `;
        // leggere variazioni
        const s = 0.95 + rand()*0.10;
        div.style.transform = `scale(${s.toFixed(3)})`;
        field.appendChild(div);
        return { div, r };
      });
      return { cognome: g.cognome, nodes };
    });

    // util overlap
    const placed = [];
    function overlaps(a,b){
      return !(a.x+a.w < b.x || b.x+b.w < a.x || a.y+a.h < b.y || b.y+b.h < a.y);
    }

    // 1) scegli un ‚Äúcentro‚Äù per ogni gruppo (cognome)
    const centers = [];
    const triesCenter = 80;

    groupNodes.forEach((g, gi) => {
      // dimensione media tag del gruppo
      const avgW = g.nodes.reduce((s,n)=> s + n.div.getBoundingClientRect().width, 0) / g.nodes.length;
      const avgH = g.nodes.reduce((s,n)=> s + n.div.getBoundingClientRect().height, 0) / g.nodes.length;

      let best = null;
      for(let t=0;t<triesCenter;t++){
        // sparsi: scegli x/y in una zona ampia
        const x = pad + rand()*(W - 2*pad);
        const y = pad + rand()*(H - 2*pad);

        // area ‚Äúvirtuale‚Äù del cluster (pi√π grande se pi√π persone)
        const radius = 14 + g.nodes.length * 18;
        const cand = { x, y, w: avgW + radius*2, h: avgH + radius*2 };

        // penalit√† per sovrapposizioni con altri cluster
        let pen = 0;
        for(const c of centers){
          if(overlaps({x:c.cx - c.w/2, y:c.cy - c.h/2, w:c.w, h:c.h},
                      {x:cand.x - cand.w/2, y:cand.y - cand.h/2, w:cand.w, h:cand.h})) pen++;
        }
        if(best === null || pen < best.pen){
          best = { cx:x, cy:y, w:cand.w, h:cand.h, pen, radius };
          if(pen === 0) break;
        }
      }
      centers.push(best);
    });

    // 2) posiziona i tag di ogni gruppo ‚Äúintorno‚Äù al suo centro
    groupNodes.forEach((g, gi) => {
      const c = centers[gi];
      const radius = c.radius;

      g.nodes.forEach((n, ni) => {
        const rect = n.div.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        // disposizione a spirale/cerchio
        const angle = (ni / Math.max(1, g.nodes.length)) * Math.PI*2 + rand()*0.35;
        const dist  = (g.nodes.length === 1) ? 0 : (8 + (ni % 3) * 18 + rand()*10);

        let x = c.cx + Math.cos(angle) * Math.min(radius, 60) + (rand()*10 - 5) - w/2;
        let y = c.cy + Math.sin(angle) * Math.min(radius, 60) + (rand()*10 - 5) - h/2;

        // clamp dentro field
        x = Math.max(pad, Math.min(W - pad - w, x));
        y = Math.max(pad, Math.min(H - pad - h, y));

        // piccoli tentativi anti-overlap con gli altri tag gi√† piazzati
        let placedRect = {x,y,w,h};
        for(let t=0;t<30;t++){
          let hit = false;
          for(const p of placed){
            if(overlaps(placedRect, p)){ hit = true; break; }
          }
          if(!hit) break;
          // sposta un filo
          x = Math.max(pad, Math.min(W - pad - w, x + (rand()*24 - 12)));
          y = Math.max(pad, Math.min(H - pad - h, y + (rand()*24 - 12)));
          placedRect = {x,y,w,h};
        }

        n.div.style.left = x + "px";
        n.div.style.top  = y + "px";

        placed.push(placedRect);
      });
    });
  }

  function step(delta){
    const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
    const next = clamp(page + delta, 0, totalPages - 1);
    if(next === page) return;

    wrap.classList.add("fade-out");
    setTimeout(() => {
      page = next;
      render();
      requestAnimationFrame(() => wrap.classList.remove("fade-out"));
    }, 220);
  }

  // Scroll pagina
  let wheelLock = false;
  window.addEventListener("wheel", (e) => {
    e.preventDefault();
    if (wheelLock) return;
    wheelLock = true;
    step(e.deltaY > 0 ? 1 : -1);
    setTimeout(() => wheelLock = false, 280);
  }, { passive:false });

  // Tastiera
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ") { e.preventDefault(); step(1); }
    if (e.key === "ArrowUp" || e.key === "PageUp") { e.preventDefault(); step(-1); }
    if (e.key === "Home") { e.preventDefault(); page=0; render(); }
    if (e.key === "End") { e.preventDefault(); page=999999; render(); }
  });

  // Swipe
  let startY = null;
  window.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    startY = e.touches[0].clientY;
  }, { passive:true });

  window.addEventListener("touchend", (e) => {
    if (startY == null) return;
    const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
    const dy = endY - startY;
    if (Math.abs(dy) > 30) step(dy < 0 ? 1 : -1);
    startY = null;
  }, { passive:true });

  // CSV
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const sep = lines[0].includes(";") ? ";" : ",";
    const headers = lines.shift().split(sep).map(h => h.trim());
    const iC = headers.findIndex(h => h.toLowerCase() === "cognome");
    const iN = headers.findIndex(h => h.toLowerCase() === "nome");
    const iL = headers.findIndex(h => h.toLowerCase() === "luogo");

    const out = [];
    for(const line of lines){
      if(!line.trim()) continue;
      const cells = line.split(sep).map(s => s.trim());
      const nome = cells[iN] || "";
      const cognome = cells[iC] || "";
      const luogo = cells[iL] || "";
      const full = (nome + " " + cognome).trim();
      if(full) out.push({ nome, cognome, luogo });
    }
    // ordinamento base: cognome, nome
    out.sort((a,b) => (a.cognome+" "+a.nome).localeCompare(b.cognome+" "+b.nome, "it"));
    return out;
  }

  async function load(){
    const res = await fetch("Morti_Terremoto.csv", { cache:"no-store" });
    const buf = await res.arrayBuffer();
    let text;
    try { text = new TextDecoder("iso-8859-1").decode(buf); }
    catch { text = new TextDecoder("utf-8").decode(buf); }

    ALL = parseCSV(text);
    VIEW = ALL.slice();

    // event: ricerca
    qEl.addEventListener("input", () => applyFilter());
    fieldSel.addEventListener("change", () => applyFilter());
    resetBtn.addEventListener("click", () => {
      qEl.value = "";
      applyFilter();
      qEl.focus();
    });

    page = 0;
    requestAnimationFrame(render);
    window.addEventListener("resize", () => requestAnimationFrame(render));
  }

  load().catch(err => {
    console.error(err);
    field.innerHTML = `<div class="tag" style="left:18px;top:18px;">
      <div class="name">Errore nel caricamento</div>
      <div class="place">Controlla che Morti_Terremoto.csv sia nella stessa cartella di index.html</div>
    </div>`;
    counter.textContent = "";
  });
</script>

</body>
</html>
