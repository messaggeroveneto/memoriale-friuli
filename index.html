<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Memoriale ‚Äì Terremoto del Friuli (1976)</title>
<style>
  :root{
    --bg:#0b0c10;
    --text:#f3f4f7;
    --muted:rgba(243,244,247,.72);
    --line:rgba(255,255,255,.10);
  }
  html,body{height:100%;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    overflow:hidden;

    /* pattern: omini pieni bianchi, leggerissimi */
    background-image:
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cg fill='%23ffffff' fill-opacity='.06'%3E%3Cpath d='M46 40a12 12 0 1 0 0.01 0z'/%3E%3Cpath d='M46 56c-14 0-26 10-26 24v14c0 4 3 7 7 7h10v33c0 4 3 7 7 7s7-3 7-7v-33h10c4 0 7-3 7-7V80c0-14-12-24-26-24z'/%3E%3Cpath d='M118 98a10 10 0 1 0 0.01 0z'/%3E%3Cpath d='M118 112c-12 0-22 9-22 20v12c0 3 3 6 6 6h8v19c0 3 3 6 6 6s6-3 6-6v-19h8c3 0 6-3 6-6v-12c0-11-10-20-22-20z'/%3E%3C/g%3E%3C/svg%3E");
    background-size: 190px 190px;
  }

  .wrap{
    position:relative;
    height:100%;
    width:100%;
  }

  /* fade di pagina */
  .fade-out .stage{
    opacity:0;
    transform: translateY(10px);
  }
  .stage{
    position:absolute;
    inset:0;
    padding:22px;
    opacity:1;
    transform: translateY(0);
    transition: opacity 420ms ease, transform 420ms ease;
  }

  /* barra alta minimale */
  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:12px;
    padding:10px 10px 0;
    color:var(--muted);
    font-size:12px;
    letter-spacing:.2px;
  }

  /* area dove spargiamo i nomi */
  .field{
    position:relative;
    height: calc(100% - 60px);
    margin-top: 10px;
    border:1px solid var(--line);
    border-radius:22px;
    background: radial-gradient(900px 500px at 50% 0%, rgba(255,255,255,.06), transparent 60%),
                rgba(0,0,0,.10);
    overflow:hidden;
  }

  .tag{
    position:absolute;
    max-width: min(520px, 72vw);
    padding:10px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.04);
    backdrop-filter: blur(6px);
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    user-select:none;
  }
  .tag .name{
    color:var(--text);
    font-weight:650;
    line-height:1.15;
    font-size: clamp(14px, 1.6vw, 18px);
    letter-spacing:.2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .tag .place{
    margin-top:6px;
    color:rgba(243,244,247,.70);
    font-size: clamp(11px, 1.2vw, 13px);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .hint{
    position:fixed;
    left:14px;
    right:14px;
    bottom:12px;
    text-align:center;
    color:rgba(243,244,247,.58);
    font-size:12px;
    pointer-events:none;
  }

  @media (prefers-reduced-motion: reduce){
    .stage{ transition:none; }
  }
</style>
</head>
<body>

<div class="wrap" id="wrap">
  <div class="stage" id="stage">
    <div class="topbar">
      <div id="title">Memoriale ‚Äì Vittime del terremoto del Friuli (1976)</div>
      <div id="counter">‚Äî</div>
    </div>
    <div class="field" id="field" aria-live="polite"></div>
  </div>
</div>

<div class="hint" id="hint">Scroll ‚Ä¢ Frecce ‚Üë ‚Üì ‚Ä¢ Touch swipe</div>

<script>
  const wrap = document.getElementById("wrap");
  const stage = document.getElementById("stage");
  const field = document.getElementById("field");
  const counter = document.getElementById("counter");

  let DATA = [];
  let page = 0;

  // quanti nomi ‚Äúsparsi‚Äù per pagina
  const PAGE_SIZE = 18;

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // RNG deterministico per avere una disposizione stabile per ogni pagina
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }

  function render(){
    const totalPages = Math.max(1, Math.ceil(DATA.length / PAGE_SIZE));
    page = clamp(page, 0, totalPages - 1);

    const start = page * PAGE_SIZE;
    const slice = DATA.slice(start, start + PAGE_SIZE);

    counter.textContent = `Pagina ${page+1} / ${totalPages} ‚Ä¢ Nomi ${start+1}-${Math.min(start+PAGE_SIZE, DATA.length)} / ${DATA.length}`;

    // pulisci e ricrea i ‚Äútag‚Äù
    field.innerHTML = "";

    // misure area
    const pad = 18;
    const W = field.clientWidth;
    const H = field.clientHeight;

    const rand = mulberry32(12345 + page * 99991);

    // piazzamento ‚Äúsparso‚Äù con tentativi per evitare sovrapposizioni grossolane
    const placed = []; // rettangoli {x,y,w,h}
    const triesPerItem = 50;

    function overlaps(a,b){
      return !(a.x+a.w < b.x || b.x+b.w < a.x || a.y+a.h < b.y || b.y+b.h < a.y);
    }

    // prima creiamo i nodi per misurarli
    const nodes = slice.map((r, i) => {
      const div = document.createElement("div");
      div.className = "tag";
      div.innerHTML = `
        <div class="name">${escapeHtml(r.n || "‚Äî")}</div>
        <div class="place">${r.l ? "üìç " + escapeHtml(r.l) : ""}</div>
      `;
      // piccola variazione di scala per ‚Äúorganicit√†‚Äù
      const s = 0.95 + rand()*0.12; // 0.95‚Äì1.07
      div.style.transform = `scale(${s.toFixed(3)})`;
      field.appendChild(div);
      return div;
    });

    // poi posizioniamo
    nodes.forEach((div) => {
      const rect = div.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      let best = null;

      for(let t=0;t<triesPerItem;t++){
        // distribuzione pi√π densa al centro, ma comunque sparsa
        const cx = 0.18 + rand()*0.64;
        const cy = 0.18 + rand()*0.64;

        const x = pad + cx*(W - 2*pad - w);
        const y = pad + cy*(H - 2*pad - h);

        const cand = {x, y, w, h};

        // penalizza sovrapposizioni
        let penalty = 0;
        for(const p of placed){
          if(overlaps(cand,p)) penalty += 1;
        }
        if(best === null || penalty < best.penalty){
          best = { ...cand, penalty };
          if(penalty === 0) break;
        }
      }

      // applica
      div.style.left = Math.max(pad, Math.min(W - pad - best.w, best.x)) + "px";
      div.style.top  = Math.max(pad, Math.min(H - pad - best.h, best.y)) + "px";

      placed.push(best);
    });
  }

  function step(delta){
    const totalPages = Math.max(1, Math.ceil(DATA.length / PAGE_SIZE));
    const next = clamp(page + delta, 0, totalPages - 1);
    if(next === page) return;

    wrap.classList.add("fade-out");
    setTimeout(() => {
      page = next;
      render();
      requestAnimationFrame(() => wrap.classList.remove("fade-out"));
    }, 220);
  }

  // Wheel: una pagina per scatto
  let wheelLock = false;
  window.addEventListener("wheel", (e) => {
    e.preventDefault();
    if (wheelLock) return;
    wheelLock = true;
    step(e.deltaY > 0 ? 1 : -1);
    setTimeout(() => wheelLock = false, 280);
  }, { passive:false });

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ") { e.preventDefault(); step(1); }
    if (e.key === "ArrowUp" || e.key === "PageUp") { e.preventDefault(); step(-1); }
    if (e.key === "Home") { e.preventDefault(); page=0; render(); }
    if (e.key === "End") { e.preventDefault(); page=999999; render(); }
  });

  // Touch swipe
  let startY = null;
  window.addEventListener("touchstart", (e) => {
    if (!e.touches || !e.touches.length) return;
    startY = e.touches[0].clientY;
  }, { passive:true });

  window.addEventListener("touchend", (e) => {
    if (startY == null) return;
    const endY = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY : startY;
    const dy = endY - startY;
    if (Math.abs(dy) > 30) step(dy < 0 ? 1 : -1);
    startY = null;
  }, { passive:true });

  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const sep = lines[0].includes(";") ? ";" : ",";
    const headers = lines.shift().split(sep).map(h => h.trim());
    const iC = headers.findIndex(h => h.toLowerCase() === "cognome");
    const iN = headers.findIndex(h => h.toLowerCase() === "nome");
    const iL = headers.findIndex(h => h.toLowerCase() === "luogo");

    const out = [];
    for(const line of lines){
      if(!line.trim()) continue;
      const cells = line.split(sep).map(s => s.trim());
      const nome = cells[iN] || "";
      const cognome = cells[iC] || "";
      const luogo = cells[iL] || "";
      const full = (nome + " " + cognome).trim();
      if(full) out.push({ n: full, l: luogo });
    }
    out.sort((a,b) => a.n.localeCompare(b.n, "it"));
    return out;
  }

  async function load(){
    // nel tuo repo il file si chiama Morti_Terremoto.csv
    const res = await fetch("Morti_Terremoto.csv", { cache:"no-store" });
    const buf = await res.arrayBuffer();
    let text;
    try { text = new TextDecoder("iso-8859-1").decode(buf); }
    catch { text = new TextDecoder("utf-8").decode(buf); }
    DATA = parseCSV(text);
    page = 0;
    // render dopo che il layout √® pronto
    requestAnimationFrame(render);
    window.addEventListener("resize", () => requestAnimationFrame(render));
  }

  load().catch(err => {
    console.error(err);
    field.innerHTML = `<div class="tag" style="left:18px;top:18px;"><div class="name">Errore nel caricamento</div><div class="place">Controlla che Morti_Terremoto.csv sia nella stessa cartella di index.html</div></div>`;
    counter.textContent = "";
  });
</script>

</body>
</html>
